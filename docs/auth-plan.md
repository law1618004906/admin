# خطة منطق المصادقة والخروج

هذا المستند يحدد المعماريات والسياسات المعتمدة لتوحيد المصادقة وتسجيل الخروج في الخادم والواجهة.

آخر تحديث: 2025-08-08

---

## 1) المصادقة عبر الكوكي HttpOnly
- استخدام أسماء كوكي ديناميكية حسب البروتوكول:
  - على https: `__Host-session`
  - على http (محليًا): `session`
- خصائص الكوكي: `HttpOnly`, `Secure` (لـ https فقط), `SameSite=Lax`, `Path=/`.
- لا يوجد أي اعتماد على `Authorization` أو `localStorage` نهائيًا في الواجهة أو الخادم.
- تطبيق CSRF بنمط Double-Submit Cookie:
  - توليد كوكي `csrf_token` عند تسجيل الدخول.
  - إرسال رأس `X-CSRF-Token` من الواجهة في كل طلب غير آمن.

## 2) التحقق الوسطي (Middleware)
- حماية جميع الصفحات المحمية، وإرجاع 302/403 عند غياب الجلسة.
- التحقق من CSRF لكل طلب: `POST/PUT/PATCH/DELETE` عبر مقارنة `X-CSRF-Token` مع كوكي `csrf_token`.
- دالة `requirePermission` تعمل كـ HOF وتقرأ الصلاحيات من `roleRel.permissions` (سلسلة JSON)، مع تطبيع وتحويلها إلى مصفوفة.

## 3) الواجهة الأمامية (Frontend)
- ضبط `fetch` افتراضيًا على `credentials: 'include'`.
- `withCsrf` helper لإضافة `X-CSRF-Token` تلقائيًا في الطلبات غير الآمنة.
- `use-auth.tsx` يجلب الجلسة من الكوكي فقط، ويحدّث الحالة عالميًا.
- `usePermissions`/`PermissionGuard` لحماية العناصر والصفحات حسب الصلاحيات.
- تحسين تجربة المستخدم: `NProgress`، `Skeletons`، `Toast` ورسائل واضحة.

## 4) تسجيل الخروج الاحترافي
- خادم:
  - إبطال/حذف الجلسة (invalidate) ومسح كوكي الجلسة (`__Host-session` أو `session`) + مسح كوكي `csrf_token`.
  - إرجاع استجابة موحّدة مع كود مناسب.
- عميل:
  - استدعاء API عبر `withCsrf` + `credentials: 'include'`.
  - إبطال كاش React Query ومسح أي حالة مستخدم داخلية.
  - إعادة توجيه سريعة إلى `/login` مع Toast تأكيدي بدون وميض.

## 5) الأدوار والصلاحيات (Prisma + API)
- نموذج `Role` مرتبط بـ `User` عبر `roleId` مع حقل `isActive`.
- تخزين `permissions` كسلسلة JSON في قاعدة البيانات وإرجاعها كمصفوفة دائمًا من الـ API.
- دعم إدخال CSV/tags وفاليديشن واضح ورسائل أخطاء مفهومة.

## 6) الأمان والموثوقية
- لا Fallback لهيدر `Authorization` في أي طبقة.
- ضبط `Secure` للكوكي عند https فقط لضمان عمل التطوير المحلي.
- تأخير بسيط بعد محاولات دخول فاشلة ورسائل لا تكشف عن تفاصيل.
- تسجيل Telemetry/Logs أساسية لأحداث المصادقة لاحقًا.

## 7) تحسينات لاحقة مقترحة (Roadmap)
- تجديد صامت للجلسة قبل انتهاء الصلاحية + تحذير انتهاء الجلسة (Inactivity/Expiry Warning).
- ErrorBoundary وصفحات 403/404/500 مخصصة.
- Health widget لفحص حالة الخادم.
- تحسينات الأداء: Prefetch/Suspense وتقسيم الحزم.

## 8) تحقق وسلامة (Checklist سريعة)
- [x] منع أي استخدام لـ `Authorization`/`localStorage` في الواجهة.
- [x] جميع الطلبات غير الآمنة تُرسل `X-CSRF-Token` تلقائيًا.
- [x] `credentials: 'include'` في كل `fetch`.
- [x] مسارات تسجيل الدخول/الخروج تضبط الكوكي حسب البروتوكول.
- [x] Middleware يتحقق من الجلسة والصلاحيات وCSRF.
- [x] مسح الجلسة والـ CSRF في تسجيل الخروج + إعادة توجيه نظيفة.

---

ملاحظة: تم توثيق هذا المستند ليتماشى مع حالة الكود الحالية، وأي تغييرات معمارية لاحقة يجب أن تُعكس هنا للحفاظ على الاتساق بين الكود والسياسات.
